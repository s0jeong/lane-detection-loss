# 도로 시설물 손상 탐지 및 분석 시스템 (Road Marking Damage Analysis System)

## 1. 프로젝트 개요

본 시스템은 대용량 항공 정사 이미지(`.tif`)에서 타일링 기반의 **YOLOv11-OBB** 모델을 사용하여 도로 시설물(차선, 횡단보도, 기호 등)을 탐지합니다. 이후, 각 탐지 객체에 대해 **SAM(Segment Anything Model)**과 컴퓨터 비전 기법을 적용하여 이상적인 모양을 추출하고, CIELAB 색상 분석을 통해 물리적 손상도를 정량적으로 계산합니다. 최종 결과는 각 객체의 위치, 종류, 손상도, 분할 좌표가 포함된 `JSON` 파일로 출력됩니다.

## 2. 주요 기능

  * **대용량 이미지 처리**: `rasterio`를 사용하여 Multi-gigabyte 크기의 GeoTIFF 이미지를 효율적으로 처리
  * **타일 기반 탐지**: 이미지를 작은 타일로 분할하여 저사양 GPU에서도 안정적인 객체 탐지 수행
  * **OBB(Oriented Bounding Box) 지원**: **YOLOv11L-OBB** 모델을 사용하여 회전된 객체도 정밀하게 탐지
  * **지능형 객체 병합**: 여러 타일에 걸쳐 분할 탐지된 객체(예: 긴 차선)를 객체의 방향성과 거리를 기반으로 지능적으로 병합
  * **하이브리드 분할 분석**:
      * **SAM**: 차선, 횡단보도 등 선형 객체에 대해 정밀하고 이상적인 사각형 형태 추출
      * **Computer Vision**: 화살표, 마름모 등 복잡한 형태의 객체에 대해 윤곽선을 추적하고 이상화
  * **강인한 손상도 분석**: **CIELAB 색 공간**을 분석하여 도로 바탕면 색 비침(bleed-through) 현상에 강인한 손상도 측정
  * **좌표계 변환**: 모든 픽셀 좌표를 GIS 시스템에서 활용 가능한 **지리 좌표계(EPSG:4326)**로 변환
  * **체크포인트 시스템**: 장시간 소요되는 분석 과정이 중단될 경우, 완료된 단계부터 **자동으로 이어서 실행**하는 기능

## 3. 시스템 아키텍처

```
┌───────────────────────┐
│  원본 orthomosaic.tif  │
└───────────────────────┘
              |
              ▼ (create_tiles.py)
┌───────────────────────┐
│   타일 데이터 생성       │
│ --------------------- │
│  - /tiles/ (이미지 조각)  │
│  - tile_coordinates.json │
└───────────────────────┘
              |
              ▼ (main.py)
┌───────────────────────┐
│   1. 객체 탐지 및 병합    │
│  (object_detector.py)  │
│ --------------------- │
│ a. 각 타일에서 YOLO 탐지 │
│ b. 전역 좌표로 변환      │
│ c. NMS로 중복 제거       │
│ d. 분할 객체 병합        │
└───────────────────────┘
              |
              |  [ 최종 탐지 객체 목록 ]
              ▼
┌───────────────────────┐
│   2. 분석 총괄 및 반복    │
│  (process_manager.py)   │
│ --------------------- │
│  🔁 탐지된 각 객체에 대해.. │
└───────────────────────┘
              |
              |  [ 객체 1개 정보 + 원본 TIF ]
              ▼
┌─────────────────────────────────────────────┐
│             3. 단일 객체 정밀 분석              │
│            (damage_analyzer.py)               │
│ ------------------------------------------- │
│ a. 원본 TIF에서 이미지 패치 추출                │
│ b. 클래스에 맞는 분석기 선택 (SAM vs CV)        │
│ c. 선택된 분석기로 모양(Segmentation) 분석      │
│ d. 분석된 모양 기준으로 손상도 계산             │
│ e. 픽셀 좌표를 EPSG:4326으로 변환             │
└─────────────────────────────────────────────┘
              |
              |  [ 분석 완료된 객체 정보 1개 ]
              ▼
┌────────────────────────────────┐
│       (Process Manager로 복귀)       │
│ ------------------------------ │
│   모든 객체 분석 완료까지 반복       │
└────────────────────────────────┘
              |
              |  [ 모든 객체의 최종 분석 결과 ]
              ▼
┌────────────────────────────────┐
│        최종 결과물 (Output)        │
│ ------------------------------ │
│  - final_analysis_results.json   │
│ (pixel/epsg4326 coords, damage)  │
└────────────────────────────────┘
```

## 4. 설치 및 환경 설정

### 사전 요구사항

  * Python 3.10 이상
  * NVIDIA GPU 및 CUDA (SAM 모델 가속을 위해 권장)
  * Debian/Ubuntu 기반 시스템의 경우 `python3-venv` 패키지
    ```bash
    sudo apt update && sudo apt install python3-venv
    ```

### 설치 과정

1.  **가상환경 생성 및 활성화**
    ```bash
    python3.10 -m venv venv
    source venv/bin/activate
    ```
2.  **필요 라이브러리 설치**
    ```bash
    pip install -r requirements.txt
    ```

## 5. 실행 방법

### **1단계: 데이터 준비 (타일 생성)**

가장 먼저, 대용량 원본 이미지를 분석 가능한 작은 타일로 분할해야 합니다.

1.  `create_tiles.py`파일을 열어 `SOURCE_IMAGE_PATH`와 `OUTPUT_DIR` 등 상단 설정 변수를 사용자 환경에 맞게 수정합니다.

2.  아래 명령어를 실행하여 타일 생성을 시작합니다.

    ```bash
    python create_tiles.py
    ```

    > 이 과정은 최초 한 번만 실행하면 됩니다.

-----

### **2단계: 전체 분석 실행**

타일 생성이 완료되면, 메인 분석 파이프라인을 실행합니다.

1.  `config.py` 파일을 열어, `ORIGINAL_IMAGE_PATH`, `TILES_DIR` 등 모든 경로가 올바른지 다시 한번 확인합니다.

    > **❗ 중요**: 만약 이전에 객체가 0개로 탐지되어 종료된 기록이 있다면, YOLO 탐지를 강제하기 위해 CHECKPOINT_DIR 폴더 안의 .json 파일들을 반드시 삭제해야 합니다.

2.  프로젝트 루트 디렉토리에서 아래 명령어를 실행합니다.

    ```bash
    python main.py
    ```

    > **💡 체크포인트**: 실행이 중간에 멈추더라도, 위 명령어를 다시 실행하면 마지막으로 성공한 지점부터 분석을 **자동으로 재개**합니다. 처음부터 다시 분석하고 싶다면 `CHECKPOINT_DIR` 폴더 안의 `.json` 파일들을 삭제하세요.

## 6. 출력 결과물

실행 완료 시 `config.py`의 `FINAL_OUTPUT_PATH`에 지정된 경로에 최종 JSON 파일이 생성됩니다. 이 파일은 각 객체에 대한 아래 정보를 포함하는 JSON 객체들의 리스트입니다.

  * **`class_name`**: 탐지된 객체의 클래스 이름 (예: "lane_line")
  * **`damage_percent`**: 계산된 손상도 (0.0 ~ 1.0, 분석 실패/제외 시 `null`)
  * **`analysis_method`**: 손상도 분석에 사용된 방법 (SAM, AdaptiveBrightness, unknown, excluded)
  * **`bbox_corners_pixel`**: 객체의 경계 상자 픽셀 좌표
  * **`bbox_corners_epsg4326`**: 객체의 경계 상자 지리 좌표 (위도, 경도)
  * **`segmentation_pixel`**: 객체의 정밀 윤곽선 픽셀 좌표
  * **`segmentation_epsg4326`**: 객체의 정밀 윤곽선 지리 좌표 (위도, 경도)

  
